# Google Threat Intelligence IOC Feeds Downloader

This Python script provides a command-line interface to download minutely feed batches and artifacts from Google Threat Intelligence IOC Feeds. It allows users to retrieve data for various threat types, including files, domains, IP addresses, and URLs, and to download specific artifacts like PCAP, memory dumps, and event logs (EVTX) from sandbox analyses.

*Gen AI Disclosure: This project was generated by Gemini Enterprise with final review and edits by a human. The underlying code was tested and is maintained by humans.*

## Features

**API Key Prompt:** Securely prompts the user for their Google Threat Intelligence API key.

**Menu-Driven Interface:** Offers a simple, interactive menu to select which feeds or artifacts to download.

**Individual and Batch Downloads:** Retrieve a single feed batch or all available batches simultaneously.

**Sample Downloads:** For file intelligence and sandbox artifacts (PCAP, memdump, EVTX), provides the option to download a small sample (2 files) for demonstration or all available files.

**Automated Time Handling:** Automatically calculates the correct timestamp for the most recent available batch, respecting the 60-minute lag.

**Error Handling:** Gracefully handles API errors, network issues, and missing feed batches (404 Not Found).

**Output Organization:** Saves downloaded feeds and artifacts into a dedicated ```feeds_output``` directory.

## Prerequisites

**Python 3.x:** The script is written in Python 3.

**Requests library:** Used for making HTTP requests to the Google Threat Intelligence API.

**Google Threat Intelligence License:** Access to these feeds requires specific licenses. Please ensure your API key has the necessary permissions.

## Installation
1. Clone or download the script: Save the provided Python code as ```ioc_feed_downloader.py```.

1. Create a virtual environment (recommended):

    ```Bash
    python3 -m venv venv
    source venv/bin/activate
    ```

1. Install the required dependencies:

    ```Bash
    pip install requests
    ```

## Usage
1. Run the script from your terminal:

    ```Bash
    python ioc_feed_downloader.py
    ```

1. Enter your API Key: The script will first prompt you for your Google Threat Intelligence API key.

1. Select an option from the menu:
A menu will appear with options to download specific feeds or artifacts.

    ```
    --- Google Threat Intelligence Feed Menu ---
    1. Get a minutely batch for File Intelligence
    2. Get a minutely batch for Sandbox Analyses
    3. Get a minutely batch for Domain Intelligence
    4. Get a minutely batch for IP Intelligence
    5. Get a minutely batch for URL Intelligence
    6. Get a minutely batch for ALL feeds

    --- File Artifacts ---
    7. Download files from the latest File Intelligence feed

    --- Sandbox Artifacts ---
    8. Download available PCAP files from the latest Sandbox Analyses feed
    9. Download available Memory Dump files from the latest Sandbox Analyses feed
    10. Download available EVTX files from the latest Sandbox Analyses feed
    11. Exit

    Enter your choice: 
    ```

    - For options **1-6**, the script will download the corresponding compressed feed file and save it as a ```.jsonl``` file in the ```feeds_output``` directory.

    - For options **7-10**, the script will first download the relevant feed (File Intelligence for option 7, Sandbox Analyses for 8-10), then ask if you want to download a sample of 2 files or all available files before saving them. Downloaded files from the file feed will have a ```.download``` extension, while sandbox artifacts (PCAP, memdump, EVTX) will have a ```.bin``` extension.

## Output
All downloaded files are saved in a directory named ```feeds_output``` in the same location as the script.

**Feeds:** ```feeds_output/{feed_endpoint}_YYYYMMDDhhmm.jsonl```

- Example: ```feeds_output/files_202407311400.jsonl```

**File Artifacts:** ```feeds_output/{SHA256_hash}.download```

- Example: ```feeds_output/a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2.download```

**Sandbox Artifacts:** ```feeds_output/{SHA256_hash}_{file_type}.bin```

- Example: ```feeds_output/a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2_pcap.bin```

## Troubleshooting

### HTTP Errors

These errors occur when the API server responds with a status code indicating a problem.

```401 Unauthorized```: This happens if your API key is invalid or has expired. The script will print an error message indicating a ```requests.exceptions.HTTPError```. 

```403 Forbidden```: Most feeds and file downloads require specific licenses. If you try to access a feed or artifact you're not licensed for, the API will return a 403 error. Please verify your license status.

```404 Not Found```: The script is specifically designed to handle this. It will print a message like "No batch found for [feed] at [time]. This is expected for missing batches." This is a normal part of the process, as some minutes may not have new data. However, if you get this error consistently for a long period, it could indicate an issue with your API key or the service itself.

```500 Internal Server Error```: This means there's a problem on the server side. The script will catch the ```requests.exceptions.HTTPError``` and display the error code. The best course of action is to try again later.

### Network and Connection Errors

These are issues related to the connection between your machine and the API server.

```requests.exceptions.ConnectionError```: Your computer failed to connect to the server. This could be due to a lack of internet connection, a firewall blocking the connection, or the server being down.

```requests.exceptions.Timeout```: The request took too long to get a response from the server. This can happen with a slow or unreliable internet connection or if the server is under heavy load.

### Data and File Handling Errors

These errors happen after the data is received, during processing.

```bz2.BZ2Error```: The script will catch this if the downloaded file is not a valid bzip2 compressed file. This could happen if the API returned an HTML error page instead of the expected file, and the script tried to decompress it. The script's error handling for this will print a specific message and remove the corrupted file.

```json.JSONDecodeError```: This error occurs when the script tries to parse a line in the downloaded ```.jsonl``` file as JSON, but the line is improperly formatted. This is rare but could happen if a feed batch is corrupted.

```FileNotFoundError```: This error would occur if, for some reason, the script fails to find the ```.jsonl``` file it just created. The current script's logic minimizes this risk, but it's a possibility if the file is moved or deleted by another process.